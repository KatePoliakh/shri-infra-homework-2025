name: Release Flow

on:
  workflow_dispatch:
    inputs:
      version:
        type: string
        description: 'Release version'

env:
  YC_REGISTRY: ${{ secrets.YC_REGISTRY }}
  VERSION: ${{ github.run_number }}

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ” Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ðŸ“¦ Configure Git user
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: ðŸ”„ Authenticate with Yandex Container Registry
        run: |
          echo "${{ secrets.YC_TOKEN }}" | docker login \
            --username oauth \
            --password-stdin \
            cr.yandex

      - name: ðŸ§ª Run Lint & Tests
        run: |
          npm ci
          npm run lint
          npm run test

      - name: ðŸ“ Get commit range
        id: commits
        run: |
            echo "ðŸ“„ Getting commit history..."
            PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
            COMMITS=$(git log --pretty=format:"%h %s" ${PREV_TAG}..HEAD)
            echo "commits=$COMMITS" >> $GITHUB_ENV
            echo "ðŸ“„ Found commits:\n$COMMITS"

      - name: ðŸŒ¿ Create release branch
        run: |
          VERSION=${{ github.run_number }}
          echo "ðŸŒ¿ Creating release branch releases/$VERSION"
          git checkout -b releases/$VERSION
          git push origin releases/$VERSION

      - name: ðŸ› ï¸ Build Docker image
        run: |
          VERSION=${{ github.run_number }}
          echo "ðŸ—ï¸ Building Docker image with tags:"
          echo " - ${{ env.YC_REGISTRY }}:$VERSION"
          echo " - ${{ env.YC_REGISTRY }}:${VERSION}_latest"
          
          docker build \
            -t ${{ env.YC_REGISTRY }}:$VERSION \
            -t ${{ env.YC_REGISTRY }}:${VERSION}_latest .

      - name: ðŸš€ Push Docker image to Yandex Container Registry
        run: |
          VERSION=${{ github.run_number }}
          echo "ðŸšš Pushing images to registry..."
          docker push ${{ env.YC_REGISTRY }}:$VERSION
          docker push ${{ env.YC_REGISTRY }}:${VERSION}_latest

      - name: ðŸ·ï¸ Create Git tag
        run: |
          VERSION=${{ github.run_number }}
          echo "ðŸ·ï¸ Creating git tag v$VERSION"
          git tag -a v$VERSION -m "Release v$VERSION"
          git push origin v$VERSION

      - name: ðŸ“„ Update CHANGELOG.md
        run: |
          VERSION=${{ github.run_number }}
          echo "ðŸ“ Updating CHANGELOG.md"
          
          echo "## Version $VERSION" > CHANGELOG.tmp
          echo "${{ env.commits }}" >> CHANGELOG.tmp
          echo "\n" >> CHANGELOG.tmp
          cat CHANGELOG.md >> CHANGELOG.tmp
          mv CHANGELOG.tmp CHANGELOG.md
          
          git add CHANGELOG.md
          git commit -m "Update CHANGELOG for version $VERSION"
          
          git push origin releases/$VERSION

      - name: ðŸ’¬ Create Release Issue via GitHub API
        id: create_issue
        run: |
          TITLE="ðŸš¢ Release v${{ github.run_number }}"
          BODY="ðŸ“… Date: $(date +'%Y-%m-%d')\nðŸ§‘ Author: ${{ github.actor }}\nðŸ”¢ Version: v${{ github.run_number }}\n\nðŸ“œ Commits:\n${{ env.commits }}\n\nðŸ“¦ Docker Image:\n\`\`\`bash\n${{ env.YC_REGISTRY }}:${{ github.run_number }}\n${{ env.YC_REGISTRY }}:${{ github.run_number }}_latest\n\`\`\`"
          
          echo "ðŸ“Œ Creating GitHub Issue: $TITLE"
          ISSUE_JSON=$(mktemp)
          cat <<EOF > $ISSUE_JSON
          {
            "title": "$TITLE",
            "body": "$BODY",
            "labels": ["release"]
          }
          EOF

          ISSUE_URL="https://api.github.com/repos/${{ github.repository }}/issues"
          RESPONSE=$(curl -fsSL --data "@$ISSUE_JSON" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "$ISSUE_URL")

          ISSUE_NUMBER=$(echo "$RESPONSE" | jq -r '.number')
          echo "ISSUE_NUMBER=$ISSUE_NUMBER" >> $GITHUB_ENV

      - name: ðŸ’¥ Comment on Issue if failed
        if: ${{ failure() }}
        run: |
          ISSUE_NUMBER=${{ env.ISSUE_NUMBER }}
          echo "ðŸ’¬ Adding error comment to issue #$ISSUE_NUMBER"
          ERROR_COMMENT="ðŸš¨ Release failed during execution.\n\nWorkflow: [Run #${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\nUser: ${{ github.actor }}\nDate: $(date +'%Y-%m-%d %T')"
          
          curl -fsSL --request POST \
            --url "https://api.github.com/repos/${{ github.repository }}/issues/$ISSUE_NUMBER/comments" \
            --header "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            --header "Accept: application/vnd.github.v3+json" \
            --data "{\"body\": \"$ERROR_COMMENT\"}"

      - name: ðŸŽ‰ Comment on Issue if success
        if: ${{ success() }}
        run: |
          ISSUE_NUMBER=${{ env.ISSUE_NUMBER }}
          echo "ðŸ’¬ Adding success comment to issue #$ISSUE_NUMBER"
          SUCCESS_COMMENT="ðŸŽ‰ Release completed successfully!\n\nWorkflow: [Run #${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          
          curl -fsSL --request POST \
            --url "https://api.github.com/repos/${{ github.repository }}/issues/$ISSUE_NUMBER/comments" \
            --header "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            --header "Accept: application/vnd.github.v3+json" \
            --data "{\"body\": \"$SUCCESS_COMMENT\"}"