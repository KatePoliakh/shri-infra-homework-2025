name: Release Flow

on:
  workflow_dispatch:
    inputs:
      version:
        type: string
        description: 'Release version'

env:
  YC_REGISTRY: ${{ secrets.YC_REGISTRY }}

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ” Checkout code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ğŸ“¦ Configure Git user
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: â˜ï¸ Install YC CLI and login to Container Registry
        env:
          YC_TOKEN: ${{ secrets.YC_TOKEN }}
        run: |
          echo "ğŸ”„ Installing Yandex Cloud CLI..."
          curl https://storage.yandexcloud.net/yandexcloud-yc/install.sh  | bash

          echo "âœ… Add CLI path manually"
          export PATH="$HOME/yandex-cloud/bin:$PATH"

          echo "ğŸ” Checking yc is installed..."
          yc --version

          echo "ğŸ” Logging into Yandex Container Registry..."
          echo "$YC_TOKEN" | docker login \
            --username oauth \
            --password-stdin \
            cr.yandex

      - name: ğŸ§ª Run Lint & Tests
        run: |
          echo "ğŸ§ª Running lint and tests..."
          npm ci
          npm run lint
          npm run test

      - name: ğŸ“ Get commit range
        id: commits
        run: |
          echo "ğŸ“„ Getting commit history..."
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          COMMITS=$(git log --pretty=format:"%h %s" ${PREV_TAG}..HEAD)
          echo "commits=$COMMITS" >> $GITHUB_ENV
          echo "ğŸ“„ Found commits:\n$COMMITS"

      - name: ğŸŒ¿ Create release branch
        run: |
          VERSION=${{ github.run_number }}
          echo "ğŸŒ¿ Creating release branch releases/$VERSION"
          git checkout -b releases/$VERSION
          git push origin releases/$VERSION

      - name: ğŸ› ï¸ Build Docker image
        run: |
          VERSION=${{ github.run_number }}
          IMAGE_NAME=$YC_REGISTRY:$VERSION
          LATEST_IMAGE=$YC_REGISTRY:${VERSION}_latest

          echo "ğŸ—ï¸ Building Docker image with tags:"
          echo " - $IMAGE_NAME"
          echo " - $LATEST_IMAGE"

          docker build -t $IMAGE_NAME -t $LATEST_IMAGE .

      - name: ğŸš€ Push Docker image to Yandex Container Registry
        run: |
          VERSION=${{ github.run_number }}
          IMAGE_NAME=$YC_REGISTRY:$VERSION
          LATEST_IMAGE=$YC_REGISTRY:${VERSION}_latest

          echo "ğŸšš Pushing image to registry..."
          docker push $IMAGE_NAME
          docker push $LATEST_IMAGE

      - name: ğŸ·ï¸ Create Git tag
        run: |
          VERSION=${{ github.run_number }}
          echo "ğŸ·ï¸ Creating git tag v$VERSION"
          git tag -a v$VERSION -m "Release v$VERSION (#${{ github.run_number }})"
          git push origin v$VERSION

      - name: ğŸ“„ Update CHANGELOG.md
        run: |
          VERSION=${{ github.run_number }}
          echo "ğŸ“ Updating CHANGELOG.md"
          echo "# v$VERSION\n\n${{ env.commits }}\n\n$(cat CHANGELOG.md)" > CHANGELOG.md
          git add CHANGELOG.md
          git commit -m "Update CHANGELOG for v$VERSION"

          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‚ĞµĞºÑƒÑ‰ÑƒÑ Ğ²ĞµÑ‚ĞºÑƒ
          CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          echo "ğŸ“Œ Current branch: $CURRENT_BRANCH â€” trying to push to this branch"

          # ĞŸÑƒÑˆĞ¸Ğ¼ Ğ² Ñ‚ĞµĞºÑƒÑ‰ÑƒÑ Ğ²ĞµÑ‚ĞºÑƒ (releases/X), Ğ° Ğ½Ğµ Ğ² main
          git push origin $CURRENT_BRANCH

      - name: ğŸ’¬ Create Release Issue via GitHub API
        id: create_issue
        run: |
          TITLE="ğŸš¢ Release v${{ github.run_number }}"
          BODY="ğŸ“… Date: $(date +'%Y-%m-%d')\nğŸ§‘ Author: ${{ github.actor }}\nğŸ”¢ Version: v${{ github.run_number }}\n\nğŸ“¦ Docker Image:\n\`\`\`bash\n$YC_REGISTRY:${{ github.run_number }}\n$YC_REGISTRY:${{ github.run_number }}_latest\n\`\`\`\n\nğŸ“œ Commits:\n${{ env.commits }}" 

          ISSUE_JSON=$(mktemp)
          cat <<EOF > $ISSUE_JSON
          {
            "title": "$TITLE",
            "body": "$BODY",
            "labels": ["release"]
          }
          EOF

          ISSUE_URL="https://api.github.com/repos/ ${{ github.repository }}/issues"
          RESPONSE=$(curl -fsSL --data "@$ISSUE_JSON" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "$ISSUE_URL")

          ISSUE_NUMBER=$(echo "$RESPONSE" | jq -r '.number')
          echo "ISSUE_NUMBER=$ISSUE_NUMBER" >> $GITHUB_ENV

      - name: ğŸ’¥ Comment on Issue if failed
        if: ${{ failure() }}
        run: |
          ISSUE_NUMBER=${{ env.ISSUE_NUMBER }}
          if [ -z "$ISSUE_NUMBER" ]; then
            echo "âš ï¸ Could not comment: no issue number found"
            exit 0
          fi

          ERROR_COMMENT="ğŸš¨ Release failed during execution.\n\nWorkflow: [Run #${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\nUser: ${{ github.actor }}\nDate: $(date +'%Y-%m-%d %T')"
          
          COMMENT_JSON=$(mktemp)
          echo "{\"body\": \"$ERROR_COMMENT\"}" > $COMMENT_JSON

          curl -fsSL --request POST \
            --url "https://api.github.com/repos/ ${{ github.repository }}/issues/${{ env.ISSUE_NUMBER }}/comments" \
            --header "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            --header "Accept: application/vnd.github.v3+json" \
            --data "@$COMMENT_JSON"

      - name: ğŸ‰ Comment on Issue if success
        if: ${{ success() }}
        run: |
          ISSUE_NUMBER=${{ env.ISSUE_NUMBER }}
          SUCCESS_COMMENT="ğŸ‰ Release completed successfully!\n\nWorkflow: [Run #${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          
          COMMENT_JSON=$(mktemp)
          echo "{\"body\": \"$SUCCESS_COMMENT\"}" > $COMMENT_JSON

          curl -fsSL --request POST \
            --url "https://api.github.com/repos/ ${{ github.repository }}/issues/${{ env.ISSUE_NUMBER }}/comments" \
            --header "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            --header "Accept: application/vnd.github.v3+json" \
            --data "@$COMMENT_JSON"