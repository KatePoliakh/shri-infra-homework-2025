name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      version:
        type: string
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Check if image exists in YCR
        env:
          YC_REGISTRY: ${{ secrets.YC_REGISTRY }}
        run: |
          IMAGE_EXISTS=$(yc container image list --registry-id $YC_REGISTRY | grep "${{ inputs.version }}_latest")
          if [ -z "$IMAGE_EXISTS" ]; then
            echo "Image not found!"
            exit 1
          fi

      - name: SSH into server and deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            docker pull $YC_REGISTRY/app:${{ inputs.version }}_latest
            docker stop infra-app || true
            docker rm infra-app || true
            docker run -d -p 3000:3000 --name infra-app $YC_REGISTRY/app:${{ inputs.version }}_latest

      - name: Comment on release issue
        uses: thollander/actions-comment-pull-request@v2
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          message: |
            ðŸš€ **Deployed to production**
            Date: $(date +"%Y-%m-%d")
            By: ${{ github.actor }}